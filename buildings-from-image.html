<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extract Buildings from GeoTIFF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      .building-hover {
        transition: fill-opacity 0.3s, color 0.3s;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center p-6 pt-0 px-0"
  >
    <header class="p-4 bg-blue-600 text-white text-xl w-full font-bold mb-10">
      Extract Buildings from a GeoTIFF
      <a
        href="index.html"
        class="bg-red-600 text-sm text-white px-3 py-1 ml-4 rounded"
        >View from OSM</a
      >
    </header>

    <div class="w-full max-w-6xl flex flex-col md:flex-row gap-6">
      <!-- Map -->
      <div
        class="w-full md:w-2/3 h-[600px] bg-white rounded-lg shadow-md overflow-hidden"
      >
        <div id="map" class="w-full h-full"></div>
      </div>

      <!-- Controls -->
      <div class="w-full md:w-1/3 flex flex-col gap-4">
        <!-- Upload -->
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h2 class="text-lg font-bold mb-2">Upload GeoTIFF Image</h2>
          <label class="block cursor-pointer">
            <input
              id="imageInput"
              type="file"
              accept=".tif,.tiff"
              class="hidden"
            />
            <div
              class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition"
            >
              <p class="text-gray-500">Click or drag a GeoTIFF image</p>
            </div>
          </label>
          <div id="imagePreview" class="grid grid-cols-1 gap-2 mt-2"></div>
        </div>

        <!-- Building Info -->
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h2 class="text-lg font-bold mb-2">Building Info</h2>
          <p>Total Buildings: <span id="buildingCount">0</span></p>
          <p id="selectedLocation" class="mt-1 text-sm text-gray-600">
            Hover a building to see its coordinates
          </p>
          <ul
            id="buildingList"
            class="mt-2 max-h-64 overflow-y-auto text-sm"
          ></ul>
        </div>
      </div>
    </div>

    <script>
      const UPLOAD_URL = "http://127.0.0.1:8000/extract/buildings/";

      // Initialize map
      const map = L.map("map").setView([6.5244, 3.3792], 100);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let selectedLayer = null;
      const selectedLocation = document.getElementById("selectedLocation");
      const buildingList = document.getElementById("buildingList");

      function addBuildingsToMap(geojson) {
        const layer = L.geoJSON(geojson, {
          style: {
            color: "blue",
            fillColor: "cyan",
            fillOpacity: 0.4,
            weight: 2,
            className: "building-hover",
          },
          onEachFeature: function (feature, layer) {
            const id = feature.properties?.id || "N/A";

            layer.bindTooltip(`Building ID: ${id}`, { sticky: true });

            layer.on("click", () => {
              if (selectedLayer)
                selectedLayer.setStyle({ color: "blue", fillColor: "cyan" });
              layer.setStyle({ color: "red", fillColor: "orange" });
              selectedLayer = layer;
              const center = layer.getBounds().getCenter();
              selectedLocation.innerText = `Selected Building Location: ${center.lat.toFixed(
                6
              )}, ${center.lng.toFixed(6)}`;
            });

            layer.on("mouseover", () => {
              layer.setStyle({ fillOpacity: 0.7 });
              const center = layer.getBounds().getCenter();
              selectedLocation.innerText = `Hovering Building (ID: ${id}) â†’ ${center.lat.toFixed(
                6
              )}, ${center.lng.toFixed(6)}`;
            });

            layer.on("mouseout", () => {
              if (selectedLayer !== layer) layer.setStyle({ fillOpacity: 0.4 });
              if (selectedLayer) {
                const center = selectedLayer.getBounds().getCenter();
                selectedLocation.innerText = `Selected Building Location: ${center.lat.toFixed(
                  6
                )}, ${center.lng.toFixed(6)}`;
              } else {
                selectedLocation.innerText =
                  "Hover a building to see its coordinates";
              }
            });
          },
        }).addTo(map);

        // Fit map to polygons
        map.fitBounds(layer.getBounds());

        return layer;
      }

      // Upload + preview
      document
        .getElementById("imageInput")
        .addEventListener("change", function () {
          const file = this.files[0];
          if (!file) return;

          // Preview file name
          const preview = document.getElementById("imagePreview");
          preview.innerHTML = `<p class="text-sm text-gray-600">${file.name}</p>`;

          // Upload to backend
          const formData = new FormData();
          formData.append("image", file);

          fetch(UPLOAD_URL, { method: "POST", body: formData })
            .then((res) => res.json())
            .then((data) => {
              console.log("Buildings from backend:", data);

              // Clear old layers + list
              buildingList.innerHTML = "";
              map.eachLayer((l) => {
                if (l instanceof L.GeoJSON) map.removeLayer(l);
              });

              // Add new buildings
              const buildingLayer = addBuildingsToMap(data);

              // Update count + list
              const features = data.features || [];
              document.getElementById("buildingCount").innerText =
                features.length;
              features.forEach((f, i) => {
                const li = document.createElement("li");
                li.innerText = `Building ${f.properties?.id || i + 1}`;
                buildingList.appendChild(li);
              });
            })
            .catch((err) =>
              console.error("Error uploading or processing image:", err)
            );
        });
    </script>
  </body>
</html>
